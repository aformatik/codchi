{"_path":"/usage/gc","_dir":"usage","_draft":false,"_partial":false,"_locale":"","title":"codchi gc","description":"Perform garbage collection of old nix store paths.","body":{"type":"root","children":[{"type":"element","tag":"h1","props":{"id":"codchi-gc"},"children":[{"type":"text","value":"codchi gc"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Perform garbage collection of old nix store paths."}]},{"type":"element","tag":"h2","props":{"id":"synopsis"},"children":[{"type":"text","value":"Synopsis"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"codchi gc"}]},{"type":"text","value":" "},{"type":"element","tag":"span","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"-d"}]},{"type":"text","value":"|"},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"--delete-old"}]}]},{"type":"text","value":" "},{"type":"element","tag":"span","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"-a"}]},{"type":"text","value":"|"},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"--all"}]}]},{"type":"element","tag":"span","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"-v"}]},{"type":"text","value":"|"},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"--verbose"}]}]},{"type":"text","value":"... "},{"type":"element","tag":"span","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"-q"}]},{"type":"text","value":"|"},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"--quiet"}]}]},{"type":"text","value":"...\n"},{"type":"element","tag":"span","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"--json"}]}]},{"type":"text","value":" "},{"type":"element","tag":"span","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"-h"}]},{"type":"text","value":"|"},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"--help"}]}]},{"type":"text","value":" "},{"type":"element","tag":"span","props":{},"children":[{"type":"element","tag":"em","props":{},"children":[{"type":"text","value":"MACHINES"}]}]}]},{"type":"element","tag":"h2","props":{"id":"description"},"children":[{"type":"text","value":"Description"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"All programs and system files reside in the append-only Nix Store. Over\ntime the store will grow in size noticably, because everytime a\n"},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"codchi rebuild"}]},{"type":"text","value":" is run, new files get added to the store. Therefore you\nmight want to perform a garbage collection from time to time."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"By default, garbage collection will "},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"not"}]},{"type":"text","value":" delete old machine\ngenerations in order to allow instantaneous rollbacks. The drawback is\nthat the store paths refered to in the old generations never get freed.\nTo also delete old generations, use "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"--delete-old"}]},{"type":"text","value":" with an optional\nminimum age (in days). Note that only explicitly listed machines\n("},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"MACHINES..."}]},{"type":"text","value":") will be processed. To process all installed machines,\nuse "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"--all"}]},{"type":"text","value":"."}]},{"type":"element","tag":"h3","props":{"id":"warning"},"children":[{"type":"text","value":"WARNING"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"In Codchi, the Nix Store is shared across all code machines, which means\nthat the garbage collector also shares a directory of roots (\"gcroots\")\nthat should be preserved, such as the current system configuration of\neach code machine. On a vanilla NixOS system, local gcroots (such as\nthose created by "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"nix build"}]},{"type":"text","value":" or direnv) are automatically registered and\nprotected from garbage collection. However, this doesn't work in Codchi\nat the moment, because the garbage collector has a different view on the\nfile system of each code machine. As a result, the local gcroots of\nindividual machines become invalid. For example, a gcroot pointing to\n"},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"/home/codchi/result"}]},{"type":"text","value":" on machine "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"foo"}]},{"type":"text","value":" is invalid from the perspective\nof Codchi, as the correct path would be "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"/data/machine/foo/result"}]},{"type":"text","value":"."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This isn't a huge issue, as the deleted store paths can be redownloaded\nor rebuilt."}]},{"type":"element","tag":"h2","props":{"id":"options"},"children":[{"type":"text","value":"Options"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"-d"}]},{"type":"text","value":", "},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"--delete-old"}]},{"type":"text","value":"="},{"type":"element","tag":"em","props":{},"children":[{"type":"text","value":"AGE"}]},{"type":"element","tag":"br","props":{},"children":[]},{"type":"text","value":"Delete old machine generations. AGE is the minimum age in days to be\ndeleted "},{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"default: 0"}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"-a"}]},{"type":"text","value":", "},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"--all"}]},{"type":"element","tag":"br","props":{},"children":[]},{"type":"text","value":"Process all machines. Requires "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"--delete-old"}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"-v"}]},{"type":"text","value":", "},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"--verbose"}]},{"type":"element","tag":"br","props":{},"children":[]},{"type":"text","value":"Increase logging verbosity"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"-q"}]},{"type":"text","value":", "},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"--quiet"}]},{"type":"element","tag":"br","props":{},"children":[]},{"type":"text","value":"Decrease logging verbosity"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"--json"}]},{"type":"element","tag":"br","props":{},"children":[]},{"type":"text","value":"Produce output in JSON format, suitable for consumption by another\nprogram"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"-h"}]},{"type":"text","value":", "},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"--help"}]},{"type":"element","tag":"br","props":{},"children":[]},{"type":"text","value":"Print help (see a summary with -h)"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"element","tag":"em","props":{},"children":[{"type":"text","value":"MACHINES"}]}]},{"type":"element","tag":"br","props":{},"children":[]},{"type":"text","value":"Machines to be processed. Requires "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"--delete-old"}]}]}]},{"type":"element","tag":"h2","props":{"id":"extra"},"children":[{"type":"text","value":"Extra"}]},{"type":"element","tag":"h3","props":{"id":"large-wsl-distributions"},"children":[{"type":"text","value":"Large WSL Distributions"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"On Windows, the store is inside the WSL distribution `codchistore'. By\ndefault WSL distributions only grow in size, once used disk space is not\nautomatically reclaimed. Codchi will try to set the distribution to\nsparse mode which should automatically free unused space. If this\ndoesn't work, you can do it automatically with"}]},{"type":"element","tag":"pre","props":{"code":"wsl.exe --manage codchistore --set-sparse true\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"wsl.exe --manage codchistore --set-sparse true\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Beware that WSL needs to be shut down for this which will close all\nrunning Linux programs."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"If sparse mode somehow doesn't work correctly, you can manually shrink a\nWSL distribution like this:"}]},{"type":"element","tag":"pre","props":{"code":"wsl.exe --terminate codchistore\ndiskpart # this will need admin rights\nselect vdisk file=\"C:UsersYOUR_USERAppDataLocalcodchistoreext4.vhdx\"\ncompact vdisk\nexit\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"wsl.exe --terminate codchistore\ndiskpart # this will need admin rights\nselect vdisk file=\"C:UsersYOUR_USERAppDataLocalcodchistoreext4.vhdx\"\ncompact vdisk\nexit\n"}]}]},{"type":"element","tag":"h2","props":{"id":"examples"},"children":[{"type":"text","value":"Examples"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Delete generations older than one month of and :"}]},{"type":"element","tag":"pre","props":{"code":"codchi gc --delete-old 30 <MACHINE_1> <MACHINE_2>\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"codchi gc --delete-old 30 <MACHINE_1> <MACHINE_2>\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Delete all but the current generation from each installed machine:"}]},{"type":"element","tag":"pre","props":{"code":"codchi gc --all --delete-old\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"codchi gc --all --delete-old\n"}]}]}],"toc":{"title":"","searchDepth":2,"depth":2,"links":[{"id":"synopsis","depth":2,"text":"Synopsis"},{"id":"description","depth":2,"text":"Description","children":[{"id":"warning","depth":3,"text":"WARNING"}]},{"id":"options","depth":2,"text":"Options"},{"id":"extra","depth":2,"text":"Extra","children":[{"id":"large-wsl-distributions","depth":3,"text":"Large WSL Distributions"}]},{"id":"examples","depth":2,"text":"Examples"}]}},"_type":"markdown","_id":"content:2.usage:gc.md","_source":"content","_file":"2.usage/gc.md","_stem":"2.usage/gc","_extension":"md"}